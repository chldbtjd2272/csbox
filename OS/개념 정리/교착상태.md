# 교착 상태
## 01. 시스템 모델
**시스템 모델** 이란, 자원들의 유형을 의미한다.
- CPU 주기, 메모리 공간, 파일, 입출력 장치 등

프로세스가 자원을 이용하는 순서
- 요청
    - 요청이 즉시 허용되지 않으면, 이 프로세스는 그 자원을 할당받을 때까지 대기
- 사용 
    - 프로세스는 자원을 이용
- 해제
    - 프로세스는 요청에 의해 할당된 자원을 사용 후 해제

[![2018-08-16_4.17.33.png](https://s22.postimg.cc/c3be63m3l/2018-08-16_4.17.33.png)](https://postimg.cc/image/4akqe4g4d/)  
**교착 상태** 란, 프로세스들에 의해 발생할 사건을 프로세스들이 서로 기다리고 있는 상태를 의미한다.
- 둘 이상의 작업이 보류 상태에 놓여 자원을 이용하기 위해 서로 기다릴 때 발생함

## 02. 교착 상태의 특징
교착 상태 발생의 네 가지 필요 조건
- 상호배제
    - 한 번에 한 프로세스만 해당 자원을 사용할 수 있어야 함
- 점유와 대기
    - 최소한 자원 하나를 보유하고 다른 프로세스에 할당된 자원을 얻기 위해 기다리는 프로세스가 있어야 함
- 비선점
    - 자원을 강제로 빼앗을 수 없음, 자원 점유 프로세스가 끝나야 해제
- 순환대기 (환형대기)
    - 대기 프로세스 집합 {P0, P1, ... Pn} 이 있을 때, P0은 P1이 보유하고 있는 자원을, P1은 P2, P2는 P3... Pn-1은 Pn, Pn은 P0이 보유하고 있는 자원을 각각 얻기 위해 대기하는 경우

자원 할당 그래프, G = (V,E)
- V = 정점들의 집합 = P + R
    - P = 시스템 내의 모든 프로세스들의 집합
    - R = 시스템 내의 모든 자원들로 구성된 집합
- E = 간선들의 집합
    - 요청 간선
        - Pi->Rj : 프로세스 Pi가 자원 Rj를 요청하고 기다리고 있는 상태
    - 할당 간선
        - Rj -> Pi : 자원 Rj가 프로세스 Pi에게 할당된 것
- 그래프에서 사이클의 존재는 교착의 필요 조건
    - 사이클이 존재하면 교착 상태일 수 있으나, 사이클이 없으면 교착 상태는 아니다.

## 03. 교착 상태 처리 방법
- 교착 상태가 되지 않도록 하는 프로토콜을 사용
    - 교착 상태 예방
    - 교착 상태 회피
- 시스템이 교착 상태에 들어가도록 허용한 다름 회복
    - 교착 상태 탐지 및 회복
    - 어렵고 비용이 많이 소요
- 교착 상태가 시스템에서 발생하지 않은 것처럼 무시
    - UNIX 등 대부부의 운영체제에서 사용
    - 대부분 시스템에서 교착 상태는 일년에 한번정도 발생
    - 응용 프로그래머가 자체적으로 해결

## 04. 교착 상태 예방
네 가지 발생 조건 중 하나만 성립하지 않도록 하면 된다.
### 상호 배제
- 상호 배제는 주변장치의 특성때문에 피하기 힘들다.
- 프린터는 상호 배제적으로 사용됨으로 이를 거부하여 교착을 방지하기는 힘듦

### 점유와 대기
- 프로세스가 자원을 요청할 때는 언제나 다른 자원들을 점유하지 않도록 함
- 각 프로세스는 수행 전에 필요한 모든 자원을 요청하여 할당함 -> 자원 활용의 효율성 감소
- 프로세스가 자원을 가지고 있지 않은 상태에서만 자원 요청을 할 수 있도록 허용함 -> 기아 상태 유발

### 비선점
- 자원을 점유한 프로세스가 할당할 수 없는 다른 자원 요청시 -> 현재 점유하고 있는 모든 자원이 선점
- 섬전된 자원들은 대기 중인 프로세스를 위한 자원 리스트에 추가
- 프로세스는 자신이 요청한 새로운 자원과 마찬가지로 이미 점유했던 자원들을 다시 확보해야 재시작 가능
- 레지스터의 경우는 비교적 간단하나 일반적으로 상태의 보존 등 여러 가지 일을 해야함

### 순환 대기
- 모든 자원들에 번호 부여 -> 전체 순서 결정
- 한 프로세스는 자신이 가진 자원보다 번호가 큰 것만 요청
- 번호의 부여는 프로세스에서 사용하는 순서와 일치
- 새로운 자원이 시스템에 추가되면, 프로그램과 시스템을 재구성
- 사용자가 손쉽고 편리하게 응용 프로그램을 작성하는데 어려움

## 05. 교착 상태 회피
교착 상태 예방보다 덜 엄격한 조건을 요구하면서, 자원의 효율성을 향상시킨다.
- 예방 : 자원 사용 제약 조건을 정적으로 사전에 설정 ( 상대적으로 경직 )
- 회피 : 자원 사용 제약 조건을 동적으로 실행 중에 설정 ( 상대적으로 유연 )

자원 요청 시, 자원할당으로 인해서 교착상태 유발 가능성 여부를 검사한다.
- 교착 상태 유발 가능성이 전혀 없으면 ( 안정 상태 ), 자원 할당
- 교착 상태 유발 가능성이 존재하면 ( 불안정 상태 ), 자원 할당 연기

어느 상태에서 자원 할당을 한 결과가 교착을 유발할 수 있는가에 대한 추가 정보 필요
- 보통 사용하는 것 : 특정 자원에 대한 최대 요구치 등

### 안정 상태 VS 불안정 상태
[![2018-08-16_4.37.10.png](https://s22.postimg.cc/7zafdd5i9/2018-08-16_4.37.10.png)](https://postimg.cc/image/pckps80t9/)  
시스템, 안정 상태 => 교착 상태가 아님  
불안정 상태
- 안정 순열이 존재하지 않는 경우, 교착 상태의 가능성 존재

교착 상태 회피
- 시스템이 불안정 상태가 아님을 보장하는 것

#### 안정 상태
시스템이 각 프로세스에 자원을 최대 수까지 어떤 순서로 할당할 수 있어서 교착 상태를 피할 수 있는 상태  
-> "안정 순서" 가 존재하는 시스템 상태  
**안정 순서** 란? 프로세스 순서 (P1, P2, ..., Pn)이 안정 순서이려면, 각 Pi가 최대로 요청하는 자원이 사용 가능한 자원과 Pj(j < i) 가 점유하고 있는 자원으로 만족될 수 있는 경우가 존재해야 함

#### 불안정 상태
사용 가능한 자원 1개를 어느 프로세스에 할당해도 프로세스를 만족시킬 수 없는 상태

### 자원 할당 그래프 알고리즘
[![2018-08-16_4.48.46.png](https://s22.postimg.cc/a6eo1g34h/2018-08-16_4.48.46.png)](https://postimg.cc/image/81ub0d1hp/)  
자원 할당 그래프를 활용
- 예약 간선 : 프로세스가 자원을 요청할 것을 의미, 점선으로 표시
- 예약 간선은 프로세스가 자원을 요청할 때 요청 간선으로 변환
- 자원은 시스템에서 미리 예약되어야 함

자원 할당 후에 사이클이 존재하면 불안정 상태 : 할당 대기

### 은행원 알고리즘
교착상태 회피 알고리즘들 중에 대표적인 예
- 은행에서 현금을 할당하는데에서 유래
- 각 프로세스에게 자원을 할당하여 교착상태가 발생하지 않음
- 모든 프로세스 작업이 완료되는 상태는 안정상태
- 교착 상태가 발생할 수 있는 상태는 불안정상태

단점
- 할당할 수 있는 자원의 일정량을 요구함
    - 자원은 수시로 유지보수가 필요
    - 고장이나 예방보수를 함으로써 일정하게 남아있는 자원의 수 파악이 어려움
- 사용자 프로세스 수가 일정해야 함
    - 현재의 다중 프로그래밍 시스템에서는 사용자의 수가 항상 변함
- 사용자가 최대 필요량을 미리 알려주도록 요구
    - 자원 할당 방법이 점점 동적으로 변함에 따라 사용자의 최대 필요량을 파악하기 어려워짐
- 교착상태 회피 알고리즘을 실행하면 시스템 과부하가 증가함
- 항상 불안정상태를 방지해야 하므로 자원 이용도가 낮음

## 06. 교착 상태 탐지
교착 상태 탐지 기법
- 교착 상태가 발생하도록 허용
- 교착 상태가 발생했는지 탐지 알고리즘
    - 은행원 알고리즘을 약간 변형 -> 현재의 상태가 교착인지 아닌지 쉽게 판단 가능
- 교착 상태로부터 회복하는 알고리즘 제공
  
교착상태 탐지 알고리즘 사용 횟수
- 탐지 알고리즘 호출 문제는 교착상태 발생 빈도수와 교착상태 발생 시 영향을 받는 프로세스의 수에 따라 결정
- 교착상태가 자주 발생하면 탐지 알고리즘도 자주 호출
- 요청을 할 때마다 교착상태 탐지 알고리즘 연산 시간 부담이 큼
- 경제적인 방법은 호출 빈도를 줄이는 것, 한 시간마다 또는 CPU 이용률이 40%로 저하될 때마다 호출

## 07. 교착 상태로부터 회복
교착상태가 소멸될 때까지 프로세스 종료 또는 자원 선점  
프로세스 종료
- 모든 교착 상태 프로세스들을 중지
    - 재실행을 위한 자원 사용과 시간 면에서 비용 증가
    - 재실행이 어려운 프로세스도 있음
- 교착상태 사이클이 제거될 때까지 하나씩 프로세스를 중지
    - 교착상태 탐지 알고리즘 호출에 대한 부담 증가
    - 최소 비용으로 어느 프로세스를 중지할 지 선택
    - 프로세스 비용 선택 요소
        - 프로세스의 우선 순위
        - 지금까지 프로세스가 수행된 시간과 종료하는 데 걸리는 시간
        - 프로세스가 사용한 자원과 수
        - 프로세스 종료를 위해 더 필요한 자원의 수
        - 복귀하는 데 포함되는 프로세스들의 수

자원 선점
- 선점한 자원을 교착상태가 해결될 때까지 다른 프로세스에 할당
- 선점 자원 선택
    - 비용을 최소화하기 위해 적절한 선점 순서를 결정
- 복귀
    - 자원을 사용한 프로세스를 안정상태로 복귀시키고, 그 상태에서 다시 시작
- 기아
    - 비용에 근거한 시스템은 동일한 희생자로 선택되기 쉬워, 기아상태가 발생
    - 비용 요소에 복귀 회수를 포함하여 계속해서 같은 희생자로 선택되지 않도록 방지

교착 상태를 다루는 결합된 방법  
세 가지 방법(예방, 회피, 탐지)을 결합하여 시스템 자원 종류에 따라 최적의 방법을 고안
- 내부 자원
    - PCB처럼 시스템에 의해 사용되는 자원
        - 자원의 순서를 통한 예방
- 중앙 기억 장치 : 사용자 작업을 저장할 수 있는 공간
    - 선점을 통한 예방
- 장치 자원
    - 할당할 수 있는 장치와 파일
        - 회피
- 교체 가능 공간
    - 사용자 작업을 저장할 수 있는 공간
        - 선점 할당